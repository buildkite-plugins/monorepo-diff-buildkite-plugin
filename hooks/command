#!/usr/bin/env bash
set -euo pipefail

# Retry configuration for downloads
# Hardcoded values - meant for transient network issues, not hard outages
max_retries=3
retry_delay=5

say() {
    echo "$1"
}

err() {
  red=$(tput setaf 1 2>/dev/null || echo '')
  reset=$(tput sgr0 2>/dev/null || echo '')
  say "${red}ERROR${reset}: $1" >&2
  exit 1
}

executable_dir="${BUILDKITE_PLUGIN_MONOREPO_DIFF_BINARY_FOLDER:-${BUILDKITE_PLUGINS_PATH:-}}"

# Default to current directory if not set
if [[ -z "${executable_dir}" ||  ${BUILDKITE_PLUGIN_MONOREPO_DIFF_BUILDKITE_PLUGIN_TEST_MODE:-false} == "true" ]]; then
  executable_dir="."
fi

# Create directory if needed
if [[ ! -d "${executable_dir}" ]]; then
  mkdir -p "${executable_dir}" || err "Cannot create directory: ${executable_dir}"
fi

# Verify writable
if [[ ! -w "${executable_dir}" ]]; then
  err "Directory not writable: ${executable_dir}"
fi

executable="${executable_dir%/}/monorepo-diff-buildkite-plugin"
executable_version_file="${executable}.version"

check_cmd() {
  command -v "$1" > /dev/null 2>&1
  return $?
}

get_architecture() {
  _ostype="$(uname -s)"
  _arch="$(uname -m)"
  _arm=("arm armhf aarch64 aarch64_be armv6l armv7l armv8l arm64e") # arm64
  _amd=("x86 x86pc i386 i686 i686-64 x64 x86_64 x86_64h athlon")    # amd64

  if [[ "${_arm[*]}" =~ ${_arch} ]]; then
    _arch="arm64"
  elif [[ "${_amd[*]}" =~ ${_arch} ]]; then
    _arch="amd64"
  elif [[ "${_arch}" != "ppc64le" ]]; then
    echo -e "ERROR: unsupported architecture \"${_arch}\"" >&2
    exit 2
  fi

  RETVAL="${_ostype}_${_arch}"
}

need_cmd() {
  if ! check_cmd "$1"; then
    err "need '$1' (command not found)"
  fi
}

# Detect platform-appropriate SHA256 command
# Returns: Sets RETVAL to command string, returns 0 on success, 1 if no command found
get_sha256_cmd() {
  if check_cmd sha256sum; then
    RETVAL="sha256sum"
    return 0
  elif check_cmd shasum; then
    RETVAL="shasum -a 256"
    return 0
  elif check_cmd sha256; then
    RETVAL="sha256"
    return 0
  else
    return 1
  fi
}

# This wraps curl or wget.
# Try curl first, if not installed, use wget instead.
downloader() {
  if check_cmd curl; then
    _dld=curl
  elif check_cmd wget; then
    _dld=wget
  else
    _dld='curl or wget' # to be used in error message of need_cmd
  fi

  if [ "$1" = --check ]; then
    need_cmd "$_dld"
  elif [ "$_dld" = curl ]; then
    curl -fL "$1" -o "$2"
  elif [ "$_dld" = wget ]; then
    wget "$1" -O "$2"
  else
    err "Unknown downloader"
  fi
}

# Retry wrapper for downloads (SUP-5615)
download_with_retry() {
  local _url="$1"
  local _dest="$2"
  local _attempt=1

  while [ $_attempt -le "$max_retries" ]; do
    say "Downloading binary (attempt ${_attempt}/${max_retries})..."
    if downloader "$_url" "$_dest"; then
      say "Download successful"
      return 0
    fi

    if [ $_attempt -lt "$max_retries" ]; then
      say "Download failed, retrying in ${retry_delay} seconds..."
      sleep "$retry_delay"
    fi
    _attempt=$((_attempt + 1))
  done

  return 1
}

# Download checksums.txt from GitHub release
# Parameters: $1 = version (e.g., "v1.8.0"), $2 = destination file path
# Returns: 0 on success, 1 on failure
download_checksums() {
  local _version="$1"
  local _dest="$2"
  local _repo="https://github.com/buildkite-plugins/monorepo-diff-buildkite-plugin"
  local _url="${_repo}/releases/download/${_version}/checksums.txt"

  if ! downloader "$_url" "$_dest"; then
    return 1
  fi

  return 0
}

# Verify binary against checksums.txt
# Parameters: $1 = path to binary file, $2 = version (e.g., "v1.8.0"), $3 = architecture (e.g., "darwin_amd64")
# Returns: 0 if valid, 1 if invalid
verify_checksum() {
  local _binary_path="$1"
  local _version="$2"
  local _arch="$3"
  local _verify_enabled="${BUILDKITE_PLUGIN_MONOREPO_DIFF_VERIFY_CHECKSUM:-false}"

  # Check if verification is disabled
  if [[ "$_verify_enabled" == "false" ]]; then
    return 0
  fi

  # Detect SHA256 command
  if ! get_sha256_cmd; then
    say "Warning: No SHA256 command found (sha256sum, shasum, or sha256), skipping verification"
    return 0
  fi
  local _sha256_cmd="$RETVAL"

  # Download checksums.txt to temporary file
  local _checksums_file
  _checksums_file=$(mktemp)

  if ! download_checksums "$_version" "$_checksums_file"; then
    say "Warning: Could not download checksums.txt, skipping verification"
    rm -f "$_checksums_file"
    return 0
  fi

  # Get expected checksum from checksums.txt
  local _binary_name="monorepo-diff-buildkite-plugin_${_arch}"
  local _expected_checksum
  _expected_checksum=$(grep "${_binary_name}" "$_checksums_file" | awk '{print $1}')

  if [[ -z "$_expected_checksum" ]]; then
    say "Warning: Checksum not found in checksums.txt for ${_binary_name}, skipping verification"
    rm -f "$_checksums_file"
    return 0
  fi

  # Calculate actual checksum
  local _actual_checksum
  if [[ "$_sha256_cmd" == "sha256" ]]; then
    # BSD format: SHA256 (file) = hash
    _actual_checksum=$($_sha256_cmd "$_binary_path" | awk '{print $4}')
  else
    # GNU/shasum format: hash  file
    _actual_checksum=$($_sha256_cmd "$_binary_path" | awk '{print $1}')
  fi

  # Clean up temporary file
  rm -f "$_checksums_file"

  # Compare checksums
  if [[ "$_actual_checksum" != "$_expected_checksum" ]]; then
    red=$(tput setaf 1 2>/dev/null || echo '')
    reset=$(tput sgr0 2>/dev/null || echo '')
    say "${red}ERROR${reset}: Checksum verification failed for $_binary_path" >&2
    say "Expected: $_expected_checksum" >&2
    say "Actual:   $_actual_checksum" >&2
    say "This may indicate a corrupted download or a security issue." >&2
    return 1
  fi

  say "Checksum verification passed"
  return 0
}

get_latest_version() {
  local _repo="https://api.github.com/repos/buildkite-plugins/monorepo-diff-buildkite-plugin"
  local _version=""

  if check_cmd curl; then
    _version=$(curl -s "${_repo}/releases/latest" | grep -oE '"tag_name": "v[0-9]+\.[0-9]+\.[0-9]+"' | cut -d'"' -f4)
  elif check_cmd wget; then
    _version=$(wget -qO- "${_repo}/releases/latest" | grep -oE '"tag_name": "v[0-9]+\.[0-9]+\.[0-9]+"' | cut -d'"' -f4)
  fi

  if [[ "$_version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "${_version}"
  fi
}

get_binary_version() {
  if [ -f "${executable_version_file}" ]; then
    cat "${executable_version_file}" | tr -d '\n'
  fi
}

get_version() {
  local _plugin=${BUILDKITE_PLUGINS:-""}
  local _version=""

  if [[ "$_plugin" =~ ^.*monorepo-diff-buildkite-plugin#?([^\"]+) ]]; then
    _version=${BASH_REMATCH[1]}
  fi

  if [[ "$_version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    true
  else
    _version=""
  fi

  RETVAL="$_version"
}

download_binary_and_run() {
  get_architecture || return 1
  local _arch="$RETVAL"
  local _repo="https://github.com/buildkite-plugins/monorepo-diff-buildkite-plugin"

  get_version || return 1
  local _specified_version="$RETVAL"
  local _latest_version=""
  local _binary_version=""
  local test_mode="${BUILDKITE_PLUGIN_MONOREPO_DIFF_BUILDKITE_PLUGIN_TEST_MODE:-false}"
  local _url=""
  local _recovery_mode=false

  if check_cmd "${executable}"; then
    _binary_version=$(get_binary_version)
    if [[ -z "$_binary_version" ]]; then
      say "Warning: Could not determine binary version, will download fresh copy"
    else
      # Before reusing cached binary, verify its checksum
      if ! verify_checksum "${executable}" "${_binary_version}" "${_arch}"; then
        say "Cached binary failed checksum verification, attempting recovery..."
        rm -f "${executable}"
        rm -f "${executable_version_file}"
        _binary_version=""
        _recovery_mode=true
      fi
    fi
  fi

  if [[ "$test_mode" == "true" ]]; then
    true
  elif [[ "$_specified_version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    if [[ -z "$_binary_version" ]] || [[ "$_binary_version" != "$_specified_version" ]]; then
      _url=${_repo}/releases/download/${_specified_version}/monorepo-diff-buildkite-plugin_${_arch}
      _binary_version="${_specified_version}"
    fi
  else
    _latest_version=$(get_latest_version)
    if [[ -z "$_latest_version" ]]; then
      say "Error: Could not determine latest version"
      exit 1
    fi
    if [[ -z "$_binary_version" ]] || [[ "$_binary_version" != "$_latest_version" ]]; then
      _url=${_repo}/releases/download/${_latest_version}/monorepo-diff-buildkite-plugin_${_arch}
      _binary_version="${_latest_version}"
    fi
  fi

  if [ -n "${_url}" ]; then
    # Use retry wrapper for resilient downloads (SUP-5615)
    if ! download_with_retry "$_url" "${executable}"; then
      say "Failed to download $_url after ${max_retries} attempts"
      exit 1
    fi
    echo "${_binary_version}" > "${executable_version_file}"

    # After successful download, verify checksum
    if ! verify_checksum "${executable}" "${_binary_version}" "${_arch}"; then
      rm -f "${executable}"
      if [[ "$_recovery_mode" == "true" ]]; then
        err "Recovery download also failed checksum verification. This may indicate a problem with the release artifacts."
      else
        err "Downloaded binary failed checksum verification and was deleted"
      fi
    fi

    # If this was a recovery download, verify it succeeded
    if [[ "$_recovery_mode" == "true" ]]; then
      say "Binary recovery successful"
    fi
  fi

  chmod +x "${executable}"

  "${executable}"
}

run_preinstalled_binary() {
  local _executable="${executable}"

  if ! check_cmd "${_executable}"; then
    _executable="$(basename "${executable}")"
    if ! check_cmd "${_executable}"; then
      err "Binary '$_executable' not found in PATH or binary_folder option. Please install it or set download: true"
    fi
  fi

  # Best-effort verification for preinstalled binaries (non-blocking)
  # Try to detect version and verify, but don't fail if we can't
  local _binary_version
  _binary_version=$(get_binary_version)
  if [[ -n "$_binary_version" ]]; then
    get_architecture || true
    local _arch="$RETVAL"
    if [[ -n "$_arch" ]]; then
      # Attempt verification but don't fail if it doesn't work
      if ! verify_checksum "${_executable}" "${_binary_version}" "${_arch}" 2>/dev/null; then
        say "Warning: Could not verify checksum for preinstalled binary (version: ${_binary_version})"
      fi
    fi
  fi

  ${_executable} "$@"
}

# Check if download option is disabled (default is true for backward compatibility)
download_enabled="${BUILDKITE_PLUGIN_MONOREPO_DIFF_DOWNLOAD:-true}"

if [[ "$download_enabled" == "false" ]]; then
  run_preinstalled_binary "$@" || exit 1
else
  download_binary_and_run "$@" || exit 1
fi
